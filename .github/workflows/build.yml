name: Build Tesseract (fully static musl)

on:
  workflow_dispatch:

jobs:
  build-static-musl:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    env:
      PREFIX: ${{ github.workspace }}/musl

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install host packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential git wget ca-certificates autoconf automake libtool pkg-config \
            bison flex python3 python3-pip meson ninja-build gawk texinfo libxml2-utils help2man cmake

      # ------------------ Setup musl cross toolchain ------------------
      - name: Restore musl toolchain cache
        id: cache-musl
        uses: actions/cache@v3
        with:
          path: $PREFIX
          key: musl-cross-make-${{ runner.os }}-v1
          fail-on-cache-miss: false

      - name: Build musl cross toolchain
        if: steps.cache-musl.outputs.cache-hit != 'true'
        run: |
          set -e
          git clone https://github.com/richfelker/musl-cross-make.git /tmp/musl-cross-make
          cd /tmp/musl-cross-make
          make TARGET=x86_64-linux-musl -j$(nproc)
          make install TARGET=x86_64-linux-musl PREFIX=$PREFIX

      - name: Save musl toolchain cache
        if: steps.cache-musl.outputs.cache-hit != 'true'
        uses: actions/cache@v3
        with:
          path: $PREFIX
          key: musl-cross-make-${{ runner.os }}-v1

      - name: Setup environment
        run: |
          echo "$PREFIX/bin" >> $GITHUB_PATH
          echo "PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig" >> $GITHUB_ENV
          echo "CC=x86_64-linux-musl-gcc" >> $GITHUB_ENV
          echo "CXX=x86_64-linux-musl-g++" >> $GITHUB_ENV
          echo "AR=x86_64-linux-musl-ar" >> $GITHUB_ENV
          echo "RANLIB=x86_64-linux-musl-ranlib" >> $GITHUB_ENV
          echo "STRIP=x86_64-linux-musl-strip" >> $GITHUB_ENV
          mkdir -p $PREFIX/{include,lib,bin}

      # ------------------ Function to build & cache dependency ------------------
      - name: Build & cache zlib
        id: zlib
        run: |
          cache_hit=false
          echo "Trying to restore cache for zlib..."
          if [ -d "$PREFIX/zlib" ] && [ "$(ls -A $PREFIX/zlib)" ]; then
            echo "Cache hit"
            cache_hit=true
          fi
          if [ "$cache_hit" = false ]; then
            cd $RUNNER_TEMP
            wget -q https://zlib.net/zlib-1.3.1.tar.gz -O zlib.tar.gz
            tar xf zlib.tar.gz
            cd zlib-1.3.1
            mkdir -p $PREFIX/zlib
            CC=x86_64-linux-musl-gcc ./configure --static --prefix=$PREFIX/zlib
            make -j$(nproc)
            make install
          fi

      - name: Cache zlib
        if: steps.zlib.outcome == 'success'
        uses: actions/cache@v3
        with:
          path: $PREFIX/zlib
          key: zlib-1.3.1-${{ runner.os }}-v1

      # ------------------ Repeat similar pattern for other deps ------------------
      # libpng
      - name: Build & cache libpng
        id: libpng
        run: |
          cache_hit=false
          if [ -d "$PREFIX/libpng" ] && [ "$(ls -A $PREFIX/libpng)" ]; then
            cache_hit=true
          fi
          if [ "$cache_hit" = false ]; then
            cd $RUNNER_TEMP
            wget -q https://download.sourceforge.net/libpng/libpng-1.6.44.tar.xz -O libpng.tar.xz
            tar xf libpng.tar.xz
            cd libpng-1.6.44
            mkdir -p $PREFIX/libpng
            CC=x86_64-linux-musl-gcc ./configure --host=x86_64-linux-musl --prefix=$PREFIX/libpng --enable-static --disable-shared
            make -j$(nproc)
            make install
          fi

      - name: Cache libpng
        if: steps.libpng.outcome == 'success'
        uses: actions/cache@v3
        with:
          path: $PREFIX/libpng
          key: libpng-1.6.44-${{ runner.os }}-v1

      # libjpeg-turbo
      - name: Build & cache libjpeg
        id: libjpeg
        run: |
          cache_hit=false
          if [ -d "$PREFIX/libjpeg" ] && [ "$(ls -A $PREFIX/libjpeg)" ]; then
            cache_hit=true
          fi
          if [ "$cache_hit" = false ]; then
            cd $RUNNER_TEMP
            wget -q https://downloads.sourceforge.net/libjpeg-turbo/libjpeg-turbo-3.0.1.tar.gz -O libjpeg.tar.gz
            tar xf libjpeg.tar.gz
            cd libjpeg-turbo-3.0.1
            mkdir build && cd build
            CC=x86_64-linux-musl-gcc CXX=x86_64-linux-musl-g++ cmake .. -DCMAKE_INSTALL_PREFIX=$PREFIX/libjpeg -DENABLE_SHARED=FALSE -DENABLE_STATIC=TRUE -DCMAKE_BUILD_TYPE=Release
            make -j$(nproc)
            make install
          fi

      - name: Cache libjpeg
        if: steps.libjpeg.outcome == 'success'
        uses: actions/cache@v3
        with:
          path: $PREFIX/libjpeg
          key: libjpeg-turbo-3.0.1-${{ runner.os }}-v1

      # Giflib
      - name: Build & cache giflib
        id: giflib
        run: |
          cache_hit=false
          if [ -d "$PREFIX/giflib" ] && [ "$(ls -A $PREFIX/giflib)" ]; then
            cache_hit=true
          fi
          if [ "$cache_hit" = false ]; then
            cd $RUNNER_TEMP
            wget -q https://downloads.sourceforge.net/giflib/giflib-5.2.2.tar.gz -O giflib.tar.gz
            tar xf giflib.tar.gz
            cd giflib-5.2.2
            mkdir -p $PREFIX/giflib
            CC=x86_64-linux-musl-gcc ./configure --prefix=$PREFIX/giflib --enable-static --disable-shared
            make -j$(nproc)
            make install
          fi

      - name: Cache giflib
        if: steps.giflib.outcome == 'success'
        uses: actions/cache@v3
        with:
          path: $PREFIX/giflib
          key: giflib-5.2.2-${{ runner.os }}-v1

      # libwebp
      - name: Build & cache libwebp
        id: libwebp
        run: |
          cache_hit=false
          if [ -d "$PREFIX/libwebp" ] && [ "$(ls -A $PREFIX/libwebp)" ]; then
            cache_hit=true
          fi
          if [ "$cache_hit" = false ]; then
            cd $RUNNER_TEMP
            wget -q https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-1.3.2.tar.gz -O libwebp.tar.gz
            tar xf libwebp.tar.gz
            cd libwebp-1.3.2
            mkdir -p $PREFIX/libwebp
            ./configure --host=x86_64-linux-musl --prefix=$PREFIX/libwebp --enable-static --disable-shared --disable-sharpyuv
            make -j$(nproc)
            make install
          fi

      - name: Cache libwebp
        if: steps.libwebp.outcome == 'success'
        uses: actions/cache@v3
        with:
          path: $PREFIX/libwebp
          key: libwebp-1.3.2-${{ runner.os }}-v1

      # libtiff
      - name: Build & cache libtiff
        id: libtiff
        run: |
          cache_hit=false
          if [ -d "$PREFIX/libtiff" ] && [ "$(ls -A $PREFIX/libtiff)" ]; then
            cache_hit=true
          fi
          if [ "$cache_hit" = false ]; then
            cd $RUNNER_TEMP
            wget -q https://download.osgeo.org/libtiff/tiff-4.6.0.tar.gz -O libtiff.tar.gz
            tar xf libtiff.tar.gz
            cd tiff-4.6.0
            mkdir -p $PREFIX/libtiff
            CC=x86_64-linux-musl-gcc ./configure --host=x86_64-linux-musl --prefix=$PREFIX/libtiff --enable-static --disable-shared --disable-lzma --disable-zstd
            make -j$(nproc)
            make install
          fi

      - name: Cache libtiff
        if: steps.libtiff.outcome == 'success'
        uses: actions/cache@v3
        with:
          path: $PREFIX/libtiff
          key: libtiff-4.6.0-${{ runner.os }}-v1

      # ------------------ Build Leptonica (no cache) ------------------
      - name: Build Leptonica
        run: |
          cd $RUNNER_TEMP
          wget -q https://github.com/DanBloomberg/leptonica/releases/download/1.86.0/leptonica-1.86.0.tar.gz -O leptonica.tar.gz
          tar xf leptonica.tar.gz
          cd leptonica-1.86.0
          ./autogen.sh || true
          CC=x86_64-linux-musl-gcc CXX=x86_64-linux-musl-g++ \
            CPPFLAGS="-I$PREFIX/include -I$PREFIX/zlib/include -I$PREFIX/libpng/include -I$PREFIX/libjpeg/include -I$PREFIX/libtiff/include -I$PREFIX/libwebp/include -I$PREFIX/giflib/include" \
            LDFLAGS="-L$PREFIX/lib -L$PREFIX/zlib/lib -L$PREFIX/libpng/lib -L$PREFIX/libjpeg/lib -L$PREFIX/libtiff/lib -L$PREFIX/libwebp/lib -L$PREFIX/giflib/lib -static" \
            ./configure --host=x86_64-linux-musl --prefix=$PREFIX --enable-static --disable-shared \
              --with-zlib --with-libpng --with-jpeg --with-libtiff --with-libwebp --with-giflib
          make -j$(nproc)
          make install

      # ------------------ Build Tesseract (no cache) ------------------
      - name: Build Tesseract
        run: |
          cd $RUNNER_TEMP
          wget -q https://github.com/tesseract-ocr/tesseract/archive/refs/tags/5.5.1.tar.gz -O tesseract.tar.gz
          tar xf tesseract.tar.gz
          cd tesseract-5.5.1
          ./autogen.sh
          CC=x86_64-linux-musl-gcc CXX=x86_64-linux-musl-g++ \
            CPPFLAGS="-I$PREFIX/include -I$PREFIX/zlib/include -I$PREFIX/libpng/include -I$PREFIX/libjpeg/include -I$PREFIX/libtiff/include -I$PREFIX/libwebp/include -I$PREFIX/giflib/include" \
            LDFLAGS="-L$PREFIX/lib -L$PREFIX/zlib/lib -L$PREFIX/libpng/lib -L$PREFIX/libjpeg/lib -L$PREFIX/libtiff/lib -L$PREFIX/libwebp/lib -L$PREFIX/giflib/lib -static" \
            CFLAGS="-O2 -pipe -static" \
            CXXFLAGS="-O2 -pipe -static -static-libstdc++ -static-libgcc" \
            ./configure --host=x86_64-linux-musl --prefix=$PREFIX --enable-static --disable-shared \
              --disable-openmp --disable-curl --disable-graphics
          make -j$(nproc)
          make install

      # ------------------ Strip & verify ------------------
      - name: Strip and verify binary
        run: |
          $PREFIX/bin/x86_64-linux-musl-strip $PREFIX/bin/tesseract || true
          echo "file:"
          file $PREFIX/bin/tesseract
          echo "readelf -l INTERP (should be none):"
          readelf -l $PREFIX/bin/tesseract | sed -n '1,120p'
          echo "ldd (should say not a dynamic executable):"
          ldd $PREFIX/bin/tesseract || true
          echo "tesseract --version:"
          $PREFIX/bin/tesseract --version || true

      # ------------------ Package artifact ------------------
      - name: Package artifact
        run: |
          mkdir -p output
          cp $PREFIX/bin/tesseract output/
          tar czvf tesseract-musl-static.tar.gz -C output .
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tesseract-musl-static
          path: tesseract-musl-static.tar.gz
