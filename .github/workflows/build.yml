name: Build Tesseract Static (musl)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    # 使用 Alpine（musl），这是最适合完全静态链接的环境
    container: alpine:3.19

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          apk update
          apk add build-base autoconf automake libtool pkgconf git autoconf-archive \
                 zlib-static zlib-dev \
                 libpng-static libpng-dev \
                 jpeg-dev \
                 tiff-dev \
                 libwebp-static libwebp-dev \
                 giflib-static giflib-dev

      - name: Build Leptonica (static)
        run: |
          wget https://github.com/DanBloomberg/leptonica/releases/download/1.86.0/leptonica-1.86.0.tar.gz
          tar xzvf leptonica-1.86.0.tar.gz
          cd leptonica-1.86.0

          ./autogen.sh || true

          ./configure \
            --prefix=/usr/local \
            --enable-static \
            --disable-shared \
            --with-zlib --with-libpng --with-jpeg --with-libtiff --with-libwebp --with-giflib

          make -j$(nproc)
          make install

      - name: Build Tesseract (fully static)
        run: |
          wget https://github.com/tesseract-ocr/tesseract/archive/refs/tags/5.5.1.tar.gz -O tesseract.tar.gz
          tar xf tesseract.tar.gz
          cd tesseract-5.5.1

          ./autogen.sh

          export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig

          ./configure \
            --prefix=/usr/local \
            --enable-static \
            --disable-shared \
            --disable-openmp \
            --disable-curl \
            --disable-graphics \
            CFLAGS="-static" \
            CXXFLAGS="-static -static-libstdc++ -static-libgcc" \
            LDFLAGS="-static -static-libstdc++ -static-libgcc"

          make -j$(nproc)
          make install

      - name: Verify static binary
        run: |
          echo "Binary info:"
          file /usr/local/bin/tesseract

          echo "Tesseract version:"
          /usr/local/bin/tesseract --version

          echo "Check dynamic dependencies (should be none):"
          ldd /usr/local/bin/tesseract || echo "Static binary confirmed"

      - name: Package output
        run: |
          mkdir output
          cp /usr/local/bin/tesseract output/
          tar czvf tesseract-musl-static.tar.gz -C output .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tesseract-musl-static
          path: tesseract-musl-static.tar.gz
