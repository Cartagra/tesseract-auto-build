name: Build Tesseract Static (GLIBC Compatible)

on:
  workflow_dispatch:

jobs:
  build:
    # 切换回 GLIBC 环境 (Ubuntu) 进行交叉编译
    runs-on: ubuntu-latest
    # 移除 container: alpine，使用 Ubuntu 默认的 glibc 环境

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu & Musl Toolchain)
        run: |
          sudo apt-get update
          # 安装基础工具、Musl 交叉编译工具
          sudo apt-get install -y build-essential autoconf automake libtool pkg-config \
                               musl-tools wget tar libicu-dev autoconf-archive
          
          # 2. 核心依赖库：在 Ubuntu 上安装 -dev 包，用于 Leptonica 配置检测
          # Note: 我们仍然需要手动处理 Leptonica 的静态链接，但 -dev 包是必须的
          sudo apt-get install -y zlib1g-dev libpng-dev libjpeg-dev libtiff-dev libwebp-dev libgif-dev 

          # 设置 Musl 交叉编译的环境变量
          export TARGET_HOST="x86_64-linux-musl"
          export CC="/usr/bin/${TARGET_HOST}-gcc"
          export CXX="/usr/bin/${TARGET_HOST}-g++"
          
          # 定义 Musl 目标库的安装目录
          export MUSL_PREFIX="/usr/local/musl"
          
          # 确保 musl-tools 已安装，并设置必要的路径
          # Musl 的头文件和库应该位于 /usr/${TARGET_HOST}/lib 和 /usr/${TARGET_HOST}/include

      - name: Download and Build Leptonica (Static via CXX)
        run: |
          wget https://github.com/DanBloomberg/leptonica/releases/download/1.86.0/leptonica-1.86.0.tar.gz
          tar xzvf leptonica-1.86.0.tar.gz
          cd leptonica-1.86.0
          
          ./autogen.sh || true
          
          # 配置 Leptonica
          # 必须使用 Musl 编译器
          CC="x86_64-linux-musl-gcc" CXX="x86_64-linux-musl-g++" \
          ./configure --prefix=/usr/local \
            --host=x86_64-linux-musl \
            --enable-static --disable-shared \
            --with-zlib --with-libpng --with-jpeg --with-libtiff --with-libwebp --with-giflib
          
          make -j$(nproc)
          make install

      - name: Download and Build Tesseract (Static via CXX)
        run: |
          wget https://github.com/tesseract-ocr/tesseract/archive/refs/tags/5.5.1.tar.gz -O tesseract-5.5.1.tar.gz
          tar xzvf tesseract-5.5.1.tar.gz
          cd tesseract-5.5.1

          ./autogen.sh

          # 设置 PKG_CONFIG_PATH，以找到 Leptonica 
          export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig
          
          # 核心配置：使用 Musl 交叉编译工具链
          # 强制静态链接 C++ 库，并添加 LDFLAGS 确保所有依赖都被静态链接
          CC="x86_64-linux-musl-gcc" CXX="x86_64-linux-musl-g++" \
          ./configure --prefix=/usr/local \
            --host=x86_64-linux-musl \
            --enable-static --disable-shared \
            --disable-openmp \
            --disable-curl \
            --disable-graphics \
            LDFLAGS="-static -static-libstdc++"

          make -j$(nproc)
          make install

      - name: Verify Static Binary
        run: |
          echo "Checking binary type..."
          file /usr/local/bin/tesseract
          
          echo "Checking version..."
          /usr/local/bin/tesseract --version
          
          echo "Checking library dependencies (should be empty for static)..."
          ldd /usr/local/bin/tesseract || echo "Not a dynamic executable"

      - name: Package result
        run: |
          mkdir output
          cp /usr/local/bin/tesseract output/
          tar czvf tesseract-static-glibc-compatible.tar.gz -C output .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tesseract-static-glibc-compatible
          path: tesseract-static-glibc-compatible.tar.gz
