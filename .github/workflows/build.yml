name: Build Tesseract (fully static musl)

on:
  workflow_dispatch:

jobs:
  build-static-musl:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    env:
      PREFIX: ${{ github.workspace }}/musl

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install host packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential git wget ca-certificates autoconf automake libtool pkg-config \
            bison flex python3 python3-pip meson ninja-build gawk texinfo libxml2-utils help2man cmake

      # ------------------ Setup musl cross toolchain ------------------
      - name: Restore musl toolchain cache
        id: cache-musl
        uses: actions/cache@v3
        with:
          path: $PREFIX
          key: musl-cross-make-${{ runner.os }}-v1
          fail-on-cache-miss: false

      - name: Build musl cross toolchain
        if: steps.cache-musl.outputs.cache-hit != 'true'
        run: |
          set -e
          git clone https://github.com/richfelker/musl-cross-make.git /tmp/musl-cross-make
          cd /tmp/musl-cross-make
          make TARGET=x86_64-linux-musl -j$(nproc)
          make install TARGET=x86_64-linux-musl PREFIX=$PREFIX

      - name: Save musl toolchain cache
        if: steps.cache-musl.outputs.cache-hit != 'true'
        uses: actions/cache@v3
        with:
          path: $PREFIX
          key: musl-cross-make-${{ runner.os }}-v1

      - name: Setup environment
        run: |
          echo "$PREFIX/bin" >> $GITHUB_PATH
          echo "PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig" >> $GITHUB_ENV
          echo "CC=x86_64-linux-musl-gcc" >> $GITHUB_ENV
          echo "CXX=x86_64-linux-musl-g++" >> $GITHUB_ENV
          echo "AR=x86_64-linux-musl-ar" >> $GITHUB_ENV
          echo "RANLIB=x86_64-linux-musl-ranlib" >> $GITHUB_ENV
          echo "STRIP=x86_64-linux-musl-strip" >> $GITHUB_ENV
          mkdir -p $PREFIX/{include,lib,bin}

      # ------------------ Function to build & cache dependency ------------------
      - name: Build & cache zlib
        id: zlib
        run: |
          cache_hit=false
          echo "Trying to restore cache for zlib..."
          if [ -d "$PREFIX/zlib" ] && [ "$(ls -A $PREFIX/zlib)" ]; then
            echo "Cache hit"
            cache_hit=true
          fi
          if [ "$cache_hit" = false ]; then
            cd $RUNNER_TEMP
            wget -q https://zlib.net/zlib-1.3.1.tar.gz -O zlib.tar.gz
            tar xf zlib.tar.gz
            cd zlib-1.3.1
            mkdir -p $PREFIX/zlib
            CC=x86_64-linux-musl-gcc ./configure --static --prefix=$PREFIX/zlib
            make -j$(nproc)
            make install
          fi

      - name: Cache zlib
        if: steps.zlib.outcome == 'success'
        uses: actions/cache@v3
        with:
