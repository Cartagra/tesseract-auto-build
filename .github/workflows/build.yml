name: Build Tesseract Static (GLIBC Compatible)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Base Toolchain (Ubuntu & Musl)
        run: |
          sudo apt-get update
          # 安装基础工具和 Musl 交叉编译工具
          sudo apt-get install -y build-essential autoconf automake libtool pkg-config \
                               musl-tools wget tar libicu-dev autoconf-archive
          
          # 设置 Musl Cross-Compilation Environment
          export TARGET_HOST="x86_64-linux-musl"
          # 定义目标依赖的安装根目录
          export MUSL_DEPS_ROOT="/opt/musl_deps"
          mkdir -p ${MUSL_DEPS_ROOT}

      - name: Build and Install giflib (Musl Target)
        # 修复 'giflib support requested but header not found' 和 Exit code 127 错误
        run: |
          GIFLIB_VERSION="5.2.1"
          wget https://downloads.sourceforge.net/project/giflib/giflib-${GIFLIB_VERSION}.tar.gz
          tar xzvf giflib-${GIFLIB_VERSION}.tar.gz
          cd giflib-${GIFLIB_VERSION}

          # 使用 Musl 交叉编译器进行编译 (使用全路径确保找到命令)
          CC="/usr/bin/x86_64-linux-musl-gcc" AR="/usr/bin/x86_64-linux-musl-ar" \
          ./configure --prefix=${MUSL_DEPS_ROOT} --host=${TARGET_HOST} --enable-static --disable-shared
          make -j$(nproc)
          make install

      - name: Download and Build Leptonica (Static via CXX)
        run: |
          wget https://github.com/DanBloomberg/leptonica/releases/download/1.86.0/leptonica-1.86.0.tar.gz
          tar xzvf leptonica-1.86.0.tar.gz
          cd leptonica-1.86.0
          
          ./autogen.sh || true
          
          # 设置环境变量，指向 Musl 目标依赖的头文件和库
          export MUSL_DEPS_ROOT="/opt/musl_deps"
          export CFLAGS="-I${MUSL_DEPS_ROOT}/include"
          export LDFLAGS="-L${MUSL_DEPS_ROOT}/lib -static"

          # 配置 Leptonica (使用全路径的 CC/CXX)
          CC="/usr/bin/x86_64-linux-musl-gcc" CXX="/usr/bin/x86_64-linux-musl-g++" \
          ./configure --prefix=/usr/local \
            --host=${TARGET_HOST} \
            --enable-static --disable-shared \
            --with-zlib --with-libpng --with-jpeg --with-libtiff --with-giflib \
            --with-libwebp=no
          
          make -j$(nproc)
          make install

      - name: Download and Build Tesseract (Static via CXX)
        run: |
          wget https://github.com/tesseract-ocr/tesseract/archive/refs/tags/5.5.1.tar.gz -O tesseract-5.5.1.tar.gz
          tar xzvf tesseract-5.5.1.tar.gz
          cd tesseract-5.5.1

          ./autogen.sh

          # 设置 PKG_CONFIG_PATH，以找到 Leptonica 
          export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig
          
          # 继承 MUSL DEPS 路径
          export MUSL_DEPS_ROOT="/opt/musl_deps"
          
          # 核心配置：使用 Musl 工具链和静态链接
          CC="/usr/bin/x86_64-linux-musl-gcc" CXX="/usr/bin/x86_64-linux-musl-g++" \
          ./configure --prefix=/usr/local \
            --host=${TARGET_HOST} \
            --enable-static --disable-shared \
            --disable-openmp \
            --disable-curl \
            --disable-graphics \
            # Explicitly pointing C++ flags to force static linking of standard library
            CXXFLAGS="-static -static-libstdc++ -I${MUSL_DEPS_ROOT}/include" \
            LDFLAGS="-static -static-libstdc++ -L${MUSL_DEPS_ROOT}/lib"

          make -j$(nproc)
          make install

      - name: Verify Static Binary
        run: |
          echo "Checking binary type..."
          file /usr/local/bin/tesseract
          
          echo "Checking version..."
          /usr/local/bin/tesseract --version
          
          echo "Checking library dependencies (should be empty for static)..."
          ldd /usr/local/bin/tesseract || echo "Result: Not a dynamic executable (Success)"

      - name: Package result
        run: |
          mkdir output
          cp /usr/local/bin/tesseract output/
          tar czvf tesseract-static-glibc-compatible.tar.gz -C output .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tesseract-static-glibc-compatible
          path: tesseract-static-glibc-compatible.tar.gz
