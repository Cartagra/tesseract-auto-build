name: Build Tesseract Static (Alpine)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    container: alpine:3.19

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apk update
          apk add --no-cache \
            build-base \
            git \
            autoconf \
            automake \
            libtool \
            pkgconf \
            autoconf-archive \
            cairo-static \
            pango-static \
            zlib-static \
            libpng-static \
            jpeg-static \
            tiff-static \
            lcms2-static \
            openjpeg-static \
            libwebp-static \
            giflib-static \
            bzip2-static

      - name: Build Leptonica (static)
        run: |
          wget https://github.com/DanBloomberg/leptonica/releases/download/1.86.0/leptonica-1.86.0.tar.gz
          tar xzf leptonica-1.86.0.tar.gz
          cd leptonica-1.86.0
          ./configure \
            --disable-shared \
            --enable-static \
            --without-giflib \
            --without-libwebp \
            --without-openjpeg \
            LDFLAGS="-static"
          make -j$(nproc)
          make install

      - name: Build Tesseract (fully static)
        run: |
          wget https://github.com/tesseract-ocr/tesseract/archive/5.5.1.tar.gz -O tesseract-5.5.1.tar.gz
          tar xzf tesseract-5.5.1.tar.gz
          cd tesseract-5.5.1

          ./autogen.sh

          # DO NOT pass -static to ./configure itself!
          # Let configure succeed first, then force static linking only in make
          export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig
          ./configure \
            --disable-shared \
            --enable-static \
            --disable-openmp \
            --prefix=/usr/local

          # Only now force full static linking
          make -j$(nproc) LDFLAGS="-static -static-libgcc -static-libstdc++"

          strip src/tesseract
          make install

      - name: Verify it's really static
        run: |
          file /usr/local/bin/tesseract
          ldd /usr/local/bin/tesseract && exit 1 || echo "Fully static âœ“"
          /usr/local/bin/tesseract --version

      - name: Package
        run: |
          mkdir -p output
          cp /usr/local/bin/tesseract output/
          tar czf tesseract-5.5.1-alpine-static-x86_64.tar.gz -C output .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tesseract-static-alpine
          path: tesseract-5.5.1-alpine-static-x86_64.tar.gz
